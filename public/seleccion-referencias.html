<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Selecci√≥n de Referencias Musicales</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --black-olive: #3f3f37;
      --engineering-orange: #c03221;
      --ash-gray: #dfe6e4;
      --orange-peel: #ffc982;
      --french-violet: #9662e4;
    }

    body {
      background-color: var(--ash-gray);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--black-olive);
      display: flex;
      flex-direction: column;
      height: 100vh;
      margin: 0;
    }

    .navbar {
      background-color: var(--black-olive);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .btn-primary {
      background-color: var(--french-violet);
      border-color: var(--french-violet);
      border-radius: 2rem;
      padding: 0.5rem 2rem;
      transition: all 0.2s ease;
    }

    .btn-primary:hover {
      background-color: #5a1fb2;
      border-color: #5a1fb2;
      transform: scale(1.05);
    }

    .btn-outline-primary {
      color: var(--french-violet);
      border-color: var(--french-violet);
      border-radius: 2rem;
      transition: all 0.2s ease;
    }

    .btn-outline-primary:hover,
    .btn-outline-primary.active {
      background-color: var(--french-violet);
      color: white;
      transform: scale(1.05);
    }

    /* Estilo para botones de g√©nero seleccionados */
    .genre-btn.active {
      background-color: var(--french-violet);
      color: white;
      box-shadow: 0 0 0 0.2rem rgba(150, 98, 228, 0.5);
    }

    header, section {
      padding-top: 2rem;
      padding-bottom: 2rem;
    }

    .fade-in {
      opacity: 0;
      animation: fadeInAnimation 1.5s ease forwards;
    }

    @keyframes fadeInAnimation {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    footer {
      background-color: var(--black-olive);
      color: #fff;
      text-align: center;
      padding: 1rem;
      position: fixed;
      bottom: 0;
      width: 100%;
    }

    .content-container {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      margin-bottom: 8rem; /* Espacio para el input y el footer */
    }

    .input-container {
      display: flex;
      gap: 0.5rem;
      padding: 1rem;
      background-color: var(--ash-gray);
      position: fixed;
      bottom: 4rem; /* Encima del footer */
      width: 100%;
      justify-content: center;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
    }

    .input-container input {
      width: 80%;
      max-width: 400px;
      padding: 0.5rem 1rem;
      border: 1px solid var(--black-olive);
      border-radius: 2rem;
    }

    .input-container button {
      padding: 0.5rem 1.5rem;
      background-color: var(--french-violet);
      color: white;
      border: none;
      border-radius: 2rem;
      cursor: pointer;
    }

    .message {
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 1rem;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
    }
  </style>
</head>
<body>

<nav class="navbar navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand mb-0 h1" href="index.html">MozAirt</a>
  </div>
</nav>

<div class="content-container" id="content-container">
  <!-- Header dentro del contenedor -->
  <header class="text-center fade-in">
    <h1>Seleccion√° referencias musicales</h1>
  </header>

  <!-- Contenido din√°mico -->
  <section id="seleccion-referencias" class="container fade-in">
    <h2 class="text-center mb-5">Eleg√≠ tus referencias musicales</h2>

    <div class="row justify-content-center mb-5">
      <div class="col-md-8 text-center">
        <input type="text" class="form-control form-control-lg text-center mb-3" placeholder="Busc√° canciones o playlists en Spotify" id="spotify-search">
        <button class="btn btn-outline-primary" onclick="buscarEnSpotify()">Buscar en Spotify</button>

      </div>
    </div>

    <div class="row justify-content-center g-3">
      <h5 class="text-center mb-4">O eleg√≠ r√°pidamente por g√©nero:</h5>
      <div class="d-flex flex-wrap justify-content-center gap-2" id="generos">
        <button class="btn btn-outline-primary genre-btn" data-genre="Melodic House & Techno">Melodic House & Techno</button>
        <button class="btn btn-outline-primary genre-btn" data-genre="Afro House">Afro House</button>
        <button class="btn btn-outline-primary genre-btn" data-genre="Tech House">Tech House</button>
        <button class="btn btn-outline-primary genre-btn" data-genre="House">House</button>
        <button class="btn btn-outline-primary genre-btn" data-genre="Deep House">Deep House</button>
        <button class="btn btn-outline-primary genre-btn" data-genre="Progressive House">Progressive House</button>
        <button class="btn btn-outline-primary genre-btn" data-genre="Minimal / Deep Tech">Minimal / Deep Tech</button>
        <button class="btn btn-outline-primary genre-btn" data-genre="Techno (Peak Time / Driving)">Techno (Peak Time / Driving)</button>
        <button class="btn btn-outline-primary genre-btn" data-genre="Techno (Raw / Deep / Hypnotic)">Techno (Raw / Deep / Hypnotic)</button>
        <button class="btn btn-outline-primary genre-btn" data-genre="Hard Techno">Hard Techno</button>
        <button class="btn btn-outline-primary genre-btn" data-genre="Trance">Trance</button>
        <button class="btn btn-outline-primary genre-btn" data-genre="Psy-Trance">Psy-Trance</button>
        <button class="btn btn-outline-primary genre-btn" data-genre="Drum & Bass">Drum & Bass</button>
        <button class="btn btn-outline-primary genre-btn" data-genre="Dubstep">Dubstep</button>
        <button class="btn btn-outline-primary genre-btn" data-genre="Trap / Future Bass">Trap / Future Bass</button>
        <button class="btn btn-outline-primary genre-btn" data-genre="Electronica">Electronica</button>
        <button class="btn btn-outline-primary genre-btn" data-genre="Indie Dance">Indie Dance</button>
        <button class="btn btn-outline-primary genre-btn" data-genre="Nu Disco / Disco">Nu Disco / Disco</button>
        <button class="btn btn-outline-primary genre-btn" data-genre="Breaks / Breakbeat / UK Bass">Breaks / Breakbeat / UK Bass</button>
        <button class="btn btn-outline-primary genre-btn" data-genre="140 / Deep Dubstep / Grime">140 / Deep Dubstep / Grime</button>
      </div>
    </div>

    <div class="row justify-content-center mt-5">
      <div class="col-md-4 text-center">
        <button class="btn btn-primary btn-lg">Continuar</button>
      </div>
    </div>
    <div id="spotify-results" class="mt-4"></div>

  </section>
</div>

<div class="input-container">
  <input type="text" id="user-input" placeholder="Escribe aqu√≠..." />
  <button onclick="sendMessage()">Enviar</button>
</div>

<footer>
  <p>&copy; 2025 MozAirt ¬∑ M√∫sica cl√°sica con inteligencia artificial</p>
</footer>

<script>
  const SPOTIFY_CLIENT_ID = 'TU_CLIENT_ID';
const SPOTIFY_REDIRECT_URI = 'http://localhost:5500'; // o la URL donde corras tu app
let accessToken = null;

function getSpotifyTokenFromURL() {
  const hash = window.location.hash;
  if (hash) {
    const params = new URLSearchParams(hash.substring(1));
    accessToken = params.get("access_token");
    if (accessToken) {
      // console.log("üé´ Token obtenido:", accessToken); // üßπ Solo para debug, comentar en producci√≥n
    }
  }
}

getSpotifyTokenFromURL();


function authenticateSpotify() {
  const scopes = ['user-read-private', 'user-read-email'];
  const url = `https://accounts.spotify.com/authorize?client_id=${SPOTIFY_CLIENT_ID}&redirect_uri=${encodeURIComponent(SPOTIFY_REDIRECT_URI)}&scope=${encodeURIComponent(scopes.join(' '))}&response_type=token`;
  window.location.href = url;
}

  const contentContainer = document.getElementById("content-container");
  const userInput = document.getElementById("user-input");

  // Funci√≥n para agregar un mensaje al contenido
 // Mensajes enriquecidos por tipo
const messageTemplates = {
  genero: (genre) => ({
    html: `
      Has seleccionado el g√©nero <strong>${genre}</strong>.<br>
      ¬øQu√© te gustar√≠a hacer?
    `,
    buttons: [
      { label: "üéµ Generar demo", onclick: `generarMIDIDesdeGenero()` },
      { label: "üéõÔ∏è Editar par√°metros", onclick: `abrirConfiguracionGenero()` }
    ]
  }),

  track: (track) => ({
    html: `
      Referencia seleccionada: <strong>${track.name}</strong> de ${track.artists}.<br>
      ¬øC√≥mo quer√©s continuar?
    `,
    buttons: [
      { label: "üéº Generar MIDI similar", onclick: `generateMIDIFromTrack('${track.id}')` },
      { label: "üìä Analizar estructura", onclick: `analyzeTrack('${track.id}')` }
    ]
  }),

  error: (msg) => ({
    html: `<strong>‚ö†Ô∏è Error:</strong> ${msg}`,
    buttons: []
  }),

  info: (msg) => ({
    html: msg,
    buttons: []
  })
};

// Reemplaza a addMessage()
function showSmartMessage(type, data) {
  const template = messageTemplates[type](data);
  const messageDiv = document.createElement("div");
  messageDiv.className = "message mozart fade-in";
  messageDiv.innerHTML = `<div>${template.html}</div>`;

  // Botones interactivos (si los hay)
  if (template.buttons.length) {
    const buttonGroup = document.createElement("div");
    buttonGroup.className = "mt-2";

    template.buttons.forEach(btn => {
      const b = document.createElement("button");
      b.className = "btn btn-outline-primary btn-sm me-2";
      b.innerHTML = btn.label;
      b.setAttribute("onclick", btn.onclick);
      buttonGroup.appendChild(b);
    });

    messageDiv.appendChild(buttonGroup);
  }

  contentContainer.appendChild(messageDiv);
  contentContainer.scrollTo({ top: contentContainer.scrollHeight, behavior: "smooth" });
}
function selectTrack(track) {
  appState.selectedTrack = track;

  // Mostrar mensaje enriquecido
  showSmartMessage("track", {
    id: track.id,
    name: track.name,
    artists: track.artists.map(a => a.name).join(", ")
  });
}





  // Funci√≥n para manejar el env√≠o de mensajes del usuario
  function sendMessage() {
    const userText = userInput.value.trim();
    if (!userText) return;

    // Agregar mensaje del usuario
    showUserMessage(userText);


    // Limpiar el input
    userInput.value = "";

    // Respuesta simulada de MozAirt
    setTimeout(() => {
      let response = "Entiendo... ¬øQu√© m√°s necesitas?";
      if (userText.toLowerCase().includes("spotify")) {
        response = `Por favor, selecciona una referencia musical.<br><br>
          <input type="text" class="form-control" id="spotify-search" placeholder="Busc√° canciones o playlists en Spotify" />
          <button class="btn btn-outline-primary mt-3" onclick="handleSpotifySearch()">Buscar en Spotify</button>`;
      } else if (userText.toLowerCase().includes("opciones")) {
        response = `Aqu√≠ tienes algunas opciones para elegir:<br><br>
          <strong>G√©neros:</strong><br>
          <button class="btn btn-outline-primary">Melodic House & Techno</button>
          <button class="btn btn-outline-primary">Afro House</button><br><br>
          <strong>Otras opciones:</strong><br>
          <button class="btn btn-outline-primary">Search en Spotify</button>`;
      }
      showSmartMessage("info", response);

    }, 500);
  }

  // Manejar el env√≠o de mensajes al presionar Enter
  userInput.addEventListener("keypress", function (event) {
    if (event.key === "Enter") {
      event.preventDefault(); // Evitar el salto de l√≠nea
      sendMessage();
    }
  });

  // Manejar selecci√≥n de g√©neros
  document.querySelectorAll('#generos .genre-btn').forEach(button => {
    button.addEventListener('click', function() {
      // Remover la clase 'active' de todos los botones de g√©nero
      document.querySelectorAll('#generos .genre-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Agregar la clase 'active' solo al bot√≥n clickeado
      this.classList.add('active');
      
      const genre = this.getAttribute("data-genre");

      // Agregar mensaje del usuario
      showUserMessage(`G√©nero seleccionado: ${genre}`);


      // Respuesta simulada de MozAirt
      setTimeout(() => {
        const response = `
          <strong>G√©nero seleccionado:</strong> ${genre}<br>
          Este g√©nero ser√° utilizado como referencia para generar tu archivo MIDI.`;
          showSmartMessage("info", response);

      }, 500);
    });
  });


 
</script>
<!-- Magenta.js -->
<script src="https://cdn.jsdelivr.net/npm/@magenta/music@1.23.1"></script>

<script>
  const selectedGenre = { value: null };

  // Marcar g√©nero seleccionado
  document.querySelectorAll('.btn-outline-primary').forEach(button => {
    button.addEventListener('click', function () {
      document.querySelectorAll('.btn-outline-primary').forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');
      selectedGenre.value = this.textContent.trim();
      showSmartMessage("genero", selectedGenre.value);

    });
  });

  // Modelo Magenta
  const musicRNN = new mm.MusicRNN('https://storage.googleapis.com/magentadata/js/checkpoints/music_rnn/basic_rnn');
  musicRNN.initialize();

  async function generarMIDIDesdeGenero() {
    if (!selectedGenre.value) {
      showSmartMessage("info", "Eleg√≠ un g√©nero para comenzar.");

      return;
    }

    // üîÅ Ac√° se podr√° integrar datos desde Spotify y ChatGPT
    // const datosSpotify = await fetch('/api/spotify', { ... });
    // const instruccionIA = await fetch('/api/openai', { body: JSON.stringify({ genero: selectedGenre.value }) });

    const seed = {
      notes: [],
      totalTime: 1.0
    };

    const quantized = mm.sequences.quantizeNoteSequence(seed, 4);
    const continuation = await musicRNN.continueSequence(quantized, 64, 1.2);
    const midi = mm.sequenceProtoToMidi(continuation);
    const blob = new Blob([midi], { type: 'audio/midi' });
    const url = URL.createObjectURL(blob);

    const link = `<a href="${url}" download="mozairt_${selectedGenre.value}.mid" class="btn btn-outline-primary mt-3">Descargar MIDI generado</a>`;
    showSmartMessage("info", `üéµ MIDI generado desde cero seg√∫n el g√©nero seleccionado.<br>${link}`);

  }
  async function buscarEnSpotify() {
  const query = document.getElementById("spotify-search").value;
  if (!accessToken) {
    authenticateSpotify();
    return;
  }

  try {
    const res = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track`, {
      headers: {
        Authorization: `Bearer ${accessToken}`
      }
    });

    // Verificar si la respuesta es exitosa
    if (!res.ok) {
      throw new Error(`Error en la respuesta: ${res.status}`);
    }

    const data = await res.json();
    if (!data.tracks || !data.tracks.items || data.tracks.items.length === 0) {
      showSmartMessage("error", "No se encontraron resultados para la b√∫squeda.");
      return;
    }

    let html = `<h5 class="mt-3">Resultados para: "${query}"</h5><div class="row">`;
    data.tracks.items.forEach(track => {
      html += `
        <div class="col-md-6 mb-3">
          <div class="card h-100 shadow-sm">
            <img src="${track.album.images[0]?.url}" class="card-img-top" alt="${track.name}">
            <div class="card-body">
              <h6 class="card-title">${track.name}</h6>
              <p class="text-muted small">${track.artists.map(a => a.name).join(', ')}</p>
              <button class="btn btn-outline-primary btn-sm">Usar como referencia</button>
            </div>
          </div>
        </div>`;
    });
    html += '</div>';
    document.getElementById("spotify-results").innerHTML = html;

  } catch (err) {
    console.error("Error al buscar en Spotify:", err);
    showSmartMessage("error", "Error al buscar en Spotify. Prob√° m√°s tarde.");
  }
}


function showUserMessage(text) {
  const messageDiv = document.createElement("div");
  messageDiv.className = "message user fade-in";
  messageDiv.textContent = text;
  contentContainer.appendChild(messageDiv);
  contentContainer.scrollTo({ top: contentContainer.scrollHeight, behavior: "smooth" });
}

  
</script>



</body>
</html>