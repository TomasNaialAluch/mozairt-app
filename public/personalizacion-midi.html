<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Personalizaci√≥n del Archivo MIDI</title>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- NexusUI -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/nexusui/2.0.4/NexusUI.min.js"></script>
  <style>
    :root {
      --black-olive: #3f3f37;
      --engineering-orange: #c03221;
      --ash-gray: #dfe6e4;
      --orange-peel: #ffc982;
      --french-violet: #9662e4;
    }
    body {
      background-color: var(--ash-gray);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--black-olive);
      display: flex;
      flex-direction: column;
      height: 100vh;
      margin: 0;
    }
    .navbar {
      background-color: var(--black-olive);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .btn-primary {
      background-color: var(--french-violet);
      border-color: var(--french-violet);
      border-radius: 2rem;
      padding: 0.5rem 2rem;
      transition: all 0.2s ease;
    }
    .btn-primary:hover {
      background-color: #5a1fb2;
      border-color: #5a1fb2;
      transform: scale(1.05);
    }
    .btn-outline-primary {
      color: var(--french-violet);
      border-color: var(--french-violet);
      border-radius: 2rem;
      transition: all 0.2s ease;
    }
    .btn-outline-primary:hover,
    .btn-outline-primary.active {
      background-color: var(--french-violet);
      color: white;
      transform: scale(1.05);
    }
    header, section {
      padding-top: 2rem;
      padding-bottom: 2rem;
    }
    .fade-in {
      opacity: 0;
      animation: fadeInAnimation 1.5s ease forwards;
    }
    @keyframes fadeInAnimation {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    footer {
      background-color: var(--black-olive);
      color: #fff;
      text-align: center;
      padding: 1rem;
      position: fixed;
      bottom: 0;
      width: 100%;
    }
    .content-container {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      margin-bottom: 8rem; /* Espacio para el input y el footer */
    }
    .input-container {
      display: flex;
      gap: 0.5rem;
      padding: 1rem;
      background-color: var(--ash-gray);
      position: fixed;
      bottom: 4rem; /* Encima del footer */
      width: 100%;
      justify-content: center;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
    }
    .input-container input {
      width: 80%;
      max-width: 400px;
      padding: 0.5rem 1rem;
      border: 1px solid var(--black-olive);
      border-radius: 2rem;
    }
    .input-container button {
      padding: 0.5rem 1.5rem;
      background-color: var(--french-violet);
      color: white;
      border: none;
      border-radius: 2rem;
      cursor: pointer;
    }
    .message {
      margin-top: 2rem;
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 1rem;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
    }
    .option-group button {
      margin-bottom: 0.5rem;
      display: block;
      width: 100%;
    }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--french-violet);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 2rem auto;
    }
    #generar-midi-btn {
      margin-top: 1rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <nav class="navbar navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand mb-0 h1" href="index.html">MozAIrt</a>
    </div>
  </nav>

  <div class="content-container" id="content-container">
    <div id="loader" class="loader" style="display: none;"></div>

    <!-- Header -->
    <header class="text-center fade-in">
      <h1>Personaliza tu archivo MIDI</h1>
    </header>

    <!-- Secci√≥n de personalizaci√≥n -->
    <section id="personalizacion-midi" class="container fade-in">
      <h2 class="text-center mb-5">Elige los elementos musicales para tu archivo MIDI</h2>
      <div class="row justify-content-center mb-5">
        <div class="col-md-8 text-center">
          <input type="file" class="form-control" id="midi-file" />
          <button class="btn btn-outline-primary mt-3" onclick="handleMidiUpload()">Cargar archivo MIDI</button>
        </div>
      </div>
      <div class="row justify-content-center g-4">
        <div class="col-md-3">
          <div class="option-group">
            <h5>Bajos y Ritmos</h5>
            <button class="btn btn-outline-primary" id="bassline-btn">Bajo (Bassline)</button>
            <button class="btn btn-outline-primary" id="percussion-btn">Percusi√≥n</button>
          </div>
        </div>
        <div class="col-md-3">
          <div class="option-group">
            <h5>Armon√≠as</h5>
            <button class="btn btn-outline-primary" id="chords-btn">Acordes (Chords)</button>
            <button class="btn btn-outline-primary" id="arpeggio-btn">Arpegios</button>
          </div>
        </div>
        <div class="col-md-3">
          <div class="option-group">
            <h5>Melod√≠as y Texturas</h5>
            <button class="btn btn-outline-primary" id="leads-btn">Leads</button>
            <button class="btn btn-outline-primary" id="pads-btn">Pads</button>
            <button class="btn btn-outline-primary" id="stabs-btn">Stabs</button>
          </div>
        </div>
        <div class="col-md-3">
          <div class="option-group">
            <h5>Sintetizadores</h5>
            <button class="btn btn-outline-primary" id="synths-btn">Synths</button>
          </div>
        </div>
      </div>
    </section>

    <div class="row justify-content-center mt-5">
      <div class="col-md-4 text-center">
        <!-- Bot√≥n que genera MIDI seg√∫n la categor√≠a seleccionada -->
        <button class="btn btn-primary btn-lg" onclick="generarMIDIConCategoria()">Generar MIDI</button>
      </div>
    </div>
  </div>

  <div class="input-container">
    <input type="text" id="user-input" placeholder="Escribe aqu√≠..." />
    <button onclick="sendMessage()">Enviar</button>
  </div>

  <footer>
    <p>&copy; 2025 MozAIrt ¬∑ M√∫sica cl√°sica con inteligencia artificial</p>
  </footer>

  <!-- Carga Magenta.js -->
  <script src="https://cdn.jsdelivr.net/npm/@magenta/music@1.23.1"></script>

  <!-- Script unificado -->
  <script>
    /***********************
     * 1) Variables globales
     ***********************/
    const contentContainer = document.getElementById("content-container");
    const userInput = document.getElementById("user-input");
    const fileInput = document.getElementById("midi-file");
    // Este objeto guardar√° qu√© categor√≠a de elemento musical se eligi√≥ (bassline, chords, leads, etc.)
    const selectedElement = { type: null };

    /*****************************
     * 2) Funciones de chat/UX
     *****************************/
    function addMessage(text, sender = "mozart") {
      const messageDiv = document.createElement("div");
      messageDiv.classList.add("message");
      if (sender === "mozart") {
        messageDiv.innerHTML = `<strong>MozAIrt:</strong> ${text}`;
      } else {
        messageDiv.innerHTML = `<strong>T√∫:</strong> ${text}`;
      }
      contentContainer.appendChild(messageDiv);
      setTimeout(() => {
        contentContainer.scrollTop = contentContainer.scrollHeight;
      }, 50);
    }

    function sendMessage() {
      const userText = userInput.value.trim();
      if (!userText) return;
      addMessage(userText, "user");
      userInput.value = "";

      // Respuesta simulada de MozAIrt
      setTimeout(() => {
        let response = "Entiendo... ¬øQu√© m√°s necesitas?";
        if (userText.toLowerCase().includes("opciones")) {
          response = `Aqu√≠ tienes algunas opciones para personalizar tu archivo MIDI:<br><br>
            <strong>Bajos y Ritmos:</strong><br>
            <button class="btn btn-outline-primary">Bajo (Bassline)</button>
            <button class="btn btn-outline-primary">Percusi√≥n</button><br><br>
            <strong>Armon√≠as:</strong><br>
            <button class="btn btn-outline-primary">Acordes (Chords)</button>
            <button class="btn btn-outline-primary">Arpegios</button><br><br>
            <strong>Melod√≠as y Texturas:</strong><br>
            <button class="btn btn-outline-primary">Leads</button>
            <button class="btn btn-outline-primary">Pads</button>
            <button class="btn btn-outline-primary">Stabs</button><br><br>
            <strong>Sintetizadores:</strong><br>
            <button class="btn btn-outline-primary">Synths</button>`;
        }
        addMessage(response, "mozart");
      }, 500);
    }

    // Para enviar con Enter
    userInput.addEventListener("keypress", function (event) {
      if (event.key === "Enter") {
        event.preventDefault();
        sendMessage();
      }
    });

    /*****************************
     * 3) Inicializar listeners
     *****************************/
    // Cuando se hace click en uno de los botones .btn-outline-primary,
    // guardamos el tipo en selectedElement.type
    document.querySelectorAll('.btn-outline-primary').forEach(button => {
      button.addEventListener('click', function () {
        document.querySelectorAll('.btn-outline-primary').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        // Ej: "bassline-btn" => "bassline"
        if (this.id) {
          selectedElement.type = this.id.replace('-btn', '');
        }
      });
    });

    /*********************************
     * 4) Configuraci√≥n de Magenta.js
     *********************************/
    const musicRNN = new mm.MusicRNN('https://storage.googleapis.com/magentadata/js/checkpoints/music_rnn/basic_rnn');
    musicRNN.initialize();

    /******************************************
     * 5) Funciones para procesamiento de MIDI
     ******************************************/
    async function handleMidiUpload() {
      if (fileInput.files.length === 0) {
        addMessage("Por favor, seleccion√° un archivo MIDI.", "mozart");
        return;
      }
      const file = fileInput.files[0];

      // Enviar archivo a Music21 (an√°lisis backend) de forma concurrente
      analizarMIDIArchivo(file);

      // Validar extensi√≥n y tipo MIME
      if (!/\.(mid|midi)$/i.test(file.name)) {
        addMessage("‚ùå Solo se aceptan archivos con extensi√≥n .MID o .MIDI", "mozart");
        return;
      }
      const allowedTypes = ['audio/midi', 'audio/x-midi', 'audio/mid'];
      if (!allowedTypes.some(type => file.type.includes(type))) {
        addMessage("‚ùå Formato de archivo no v√°lido.", "mozart");
        return;
      }

      const loader = document.getElementById("loader");
      try {
        loader.style.display = "block";
        const reader = new FileReader();
        reader.onload = async function (e) {
          try {
            const midiData = new Uint8Array(e.target.result);
            let midi = mm.midiToSequenceProto(midiData);

            // Extraemos info de las notas para dar feedback
            const pitchInfo = extraerPitches(midi);
            const minPitch = Math.min(...pitchInfo);
            const maxPitch = Math.max(...pitchInfo);

            let mensaje = "‚úÖ Archivo MIDI ajustado para trabajar con Magenta.<br>";
            if (minPitch < 48) {
              const subidas = Math.ceil((48 - minPitch) / 12);
              mensaje += `üîº Subido ${subidas} octava${subidas > 1 ? "s" : ""} para empezar desde C3.<br>`;
            }
            if (maxPitch > 84) {
              mensaje += "üîΩ Bajado 1 octava para evitar notas superiores a C6.<br>";
            }
            if (pitchInfo.some(p => p < 36 || p > 84)) {
              mensaje += "üîÅ Algunas notas individuales fueron ajustadas para quedar en el rango C2-C6.<br>";


            }
            addMessage(mensaje, "mozart");

            // Guardamos el MIDI en una variable global
            window.midiGuardado = midi;

            // Verificar cu√°ntas pistas hay
            const numTracks = midi.tracks?.length || 1;
            if (numTracks > 1) {
              addMessage(`‚ö†Ô∏è Tu archivo MIDI tiene ${numTracks} pistas. Se recomienda trabajar con una sola pista.`, "mozart");
            }

            // Mostramos info adicional (BPM, tonalidad, cantidad de notas)
            const quantized = mm.sequences.quantizeNoteSequence(midi, 4);
            const bpm = quantized.tempos?.[0]?.qpm || "Desconocido";
            const key = quantized.keySignatures?.[0]?.key || "Sin info";
            const totalNotes = quantized.notes.length;
            addMessage(`
              <strong>üéµ Informaci√≥n del MIDI:</strong><br>
              BPM: ${bpm}<br>
              Tonalidad: ${key}<br>
              Notas totales: ${totalNotes}
            `, "mozart");

            // Insertar piano roll
            insertPianoRoll();

          } catch (procError) {
            addMessage("‚ö†Ô∏è Error al procesar el archivo MIDI.", "mozart");
            console.error("Error en procesamiento:", procError);
          } finally {
            loader.style.display = "none";
          }
        };
        reader.readAsArrayBuffer(file);
      } catch (error) {
        addMessage("‚ö†Ô∏è Ocurri√≥ un error inesperado.", "mozart");
        console.error("Error inesperado:", error);
        loader.style.display = "none";
      }
    }

    // Env√≠a el archivo a tu backend con Music21
    async function analizarMIDIArchivo(file) {
      const loader = document.getElementById("loader");
      loader.style.display = "block";

      const formData = new FormData();
      formData.append("file", file);

      try {
        const response = await fetch("https://mozairt-backend.onrender.com/analyze", {
          method: "POST",
          body: formData
        });
        const data = await response.json();

        if (data.error) {
          addMessage("‚ùå Error al analizar el MIDI: " + data.error, "mozart");
        } else {
          addMessage(`
            üéµ <strong>MIDI analizado (con Music21):</strong><br>
            BPM: ${data.bpm || "?"}<br>
            Tonalidad: ${data.key || "?"}<br>
            Comp√°s: ${data.time_signature || "?"}<br>
            Compases: ${data.measures || "?"}
          `, "mozart");
        }
      } catch (err) {
        addMessage("‚ö†Ô∏è No se pudo analizar el archivo MIDI. Intentalo de nuevo.", "mozart");
        console.error(err);
      } finally {
        loader.style.display = "none";
      }
    }

    // Muestra el piano roll (usando NexusUI)
    function insertPianoRoll() {
      const messageDiv = document.createElement("div");
      messageDiv.classList.add("message");
      messageDiv.innerHTML = `<div id="piano-roll-container"></div>`;
      contentContainer.appendChild(messageDiv);

      const piano = new Nexus.Piano('#piano-roll-container', {
        size: [500, 150],
        lowNote: 48,  // C3
        highNote: 84  // C6
      });
      setTimeout(() => {
        contentContainer.scrollTop = contentContainer.scrollHeight;
      }, 50);
    }

    /**********************************************************
     * 6) Funciones para generaci√≥n de MIDI (con la categor√≠a elegida)
     **********************************************************/
    async function generarMIDIConCategoria() {
      // Verificamos que haya un MIDI cargado
      if (!window.midiGuardado) {
        addMessage("‚ö†Ô∏è Primero sub√≠ un archivo MIDI v√°lido.", "mozart");
        return;
      }
      // Verificamos que se haya elegido un tipo (bassline, chords, leads, etc.)
      if (!selectedElement.type) {
        addMessage("‚ö†Ô∏è Eleg√≠ qu√© quer√©s generar: lead, bassline, acordes, etc.", "mozart");
        return;
      }
      try {
        // Cuantizamos el MIDI subido
        const quantized = mm.sequences.quantizeNoteSequence(window.midiGuardado, 4);
        console.log("üéº Quantized MIDI:", quantized);
        console.log("‚è≥ Enviando a Magenta...", selectedElement.type);

        // Generamos continuaci√≥n con MusicRNN
        const continuation = await musicRNN.continueSequence(quantized, 32, 1.2);
        console.log("‚úÖ Magenta devolvi√≥ una continuaci√≥n");

        // Concatenamos la secuencia original con la generada
        const combined = mm.sequences.concatenate([quantized, continuation]);
        const newMidi = mm.sequenceProtoToMidi(combined);
        const blob = new Blob([newMidi], { type: 'audio/midi' });

        // Link de descarga local
        const url = URL.createObjectURL(blob);
        const localLink = `<a href="${url}" download="mozairt_output.mid" class="btn btn-outline-primary mt-3">‚¨áÔ∏è Descargar directo</a>`;

        // Subimos a la nube
        const uploadForm = new FormData();
        uploadForm.append("file", blob, "mozairt_output.mid");
        const uploadRes = await fetch("https://mozairt-app-git-main-naials-projects.vercel.app/api/upload", {
          method: "POST",
          body: uploadForm
        });
        const isJson = uploadRes.headers.get("content-type")?.includes("application/json");
        if (!isJson) {
          addMessage("‚ö†Ô∏è El servidor no devolvi√≥ una respuesta v√°lida (no es JSON).", "mozart");
          return;
        }
        const uploadData = await uploadRes.json();
        if (uploadRes.ok && uploadData.url) {
          const cloudLink = `<a href="${uploadData.url}" target="_blank" class="btn btn-outline-primary mt-3">üì§ Descargar desde la nube</a>`;
          addMessage(`‚úÖ MIDI generado como <strong>${selectedElement.type}</strong>.<br>${localLink}<br><br>${cloudLink}`, "mozart");
        } else {
          addMessage(`‚úÖ MIDI generado como <strong>${selectedElement.type}</strong>.<br>${localLink}<br><br>‚ö†Ô∏è No se pudo subir a la nube.`, "mozart");
        }
      } catch (error) {
        console.error("‚ùå Error exacto en continueSequence:", error);
        addMessage("‚ùå Ocurri√≥ un error al generar el nuevo MIDI. Prob√° de nuevo o us√° otro archivo.", "mozart");
      }
    }

    /*****************************************
     * 7) Funciones auxiliares para manipular notas
     *****************************************/
    function normalizarMidiParaMagenta(midi) {
      // Si no hay notas, retornamos tal cual
      if (!midi.notes || midi.notes.length === 0) return midi;

      // Sacamos todos los pitches
      const allPitches = midi.notes.flatMap(note =>
        note.pitch !== undefined ? [note.pitch] :
        note.pitches ? note.pitches : []
      );
      const minPitch = Math.min(...allPitches);
      const maxPitch = Math.max(...allPitches);

      // 1Ô∏è‚É£ Transponer hacia arriba hasta C3 si hace falta
      let octavasArriba = 0;
      if (minPitch < 48) {
        octavasArriba = Math.ceil((48 - minPitch) / 12);
      }
      const transposed = {
        ...midi,
        notes: midi.notes.map(note => transponerNota(note, octavasArriba * 12))
      };

      const newMax = Math.max(...extraerPitches(transposed.notes));
      if (newMax <= 84) return transposed;

      // 3Ô∏è‚É£ Bajamos todo 1 octava si a√∫n se pasa de C6
      const bajado = {
        ...transposed,
        notes: transposed.notes.map(note => transponerNota(note, -12))
      };
      const finalMax = Math.max(...extraerPitches(bajado.notes));
      const finalMin = Math.min(...extraerPitches(bajado.notes));

      // 4Ô∏è‚É£ Si estamos en rango C2‚ÄìC6, listo
      if (finalMin >= 36 && finalMax <= 84) return bajado;

      // 5Ô∏è‚É£ Ajustamos individualmente las notas que se pasen
      const ajustado = {
        ...bajado,
        notes: bajado.notes.map(note => ajustarNota(note))
      };
      return ajustado;
    }

    function extraerPitches(notes) {
      if (!Array.isArray(notes)) return [];
      return notes.flatMap(n =>
        n.pitch !== undefined ? [n.pitch] :
        n.pitches ? n.pitches : []
      );
    }

    function transponerNota(note, semitonos) {
      if (note.pitch !== undefined) {
        return { ...note, pitch: note.pitch + semitonos };
      } else if (note.pitches) {
        return { ...note, pitches: note.pitches.map(p => p + semitonos) };
      }
      return note;
    }

    function ajustarNota(note) {
      if (note.pitch !== undefined) {
        let pitch = note.pitch;
        while (pitch > 84) pitch -= 12;
        while (pitch < 36) pitch += 12;
        return { ...note, pitch };
      } else if (note.pitches) {
        const adjusted = note.pitches.map(p => {
          while (p > 84) p -= 12;
          while (p < 36) p += 12;
          return p;
        });
        return { ...note, pitches: adjusted };
      }
      return note;
    }
  </script>
</body>
</html>
